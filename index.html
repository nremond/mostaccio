<!DOCTYPE html>
<html>
    <head>
        <title>Capture Photo</title>
        
        <script type="text/javascript" charset="utf-8" src="js/cordova-1.5.0.js"></script>
        <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script> 
        <script type="text/javascript" src="js/facedetection/ccv.js"></script> 
        <script type="text/javascript" src="js/facedetection/face.js"></script>
        <script type="text/javascript" src="js/jquery.facedetection.js"></script> 
        
        <script type="text/javascript" charset="utf-8">        
            var pictureSource;   // picture source
            var destinationType; // sets the format of returned value 
            
            // Wait for PhoneGap to connect with the device
            //
            document.addEventListener("deviceready",onDeviceReady,false);
            
            // PhoneGap is ready to be used!
            //
            function onDeviceReady() {
                pictureSource = navigator.camera.PictureSourceType;
                destinationType = navigator.camera.DestinationType;
            }
            
            // Called when a photo is successfully retrieved
            //
            /*function onPhotoDataSuccess(imageData) {
                // Uncomment to view the base64 encoded image data
                //alert(imageData);
                
                // Get image handle
                //
                var smallImage = document.getElementById('smallImage');
                
                // Unhide image elements
                //
                smallImage.style.display = 'block';
                
                // Show the captured photo
                // The inline CSS rules are used to resize the image
                //
                smallImage.src = "data:image/jpeg;base64," + imageData;
            }*/
            
            // Called when a photo is successfully retrieved
            //
            function onPhotoURISuccess(imageURI) {
                // Uncomment to view the image file URI 
                //alert(imageURI);
                
                // Get image handle
                //
                var largeImage = document.getElementById('largeImage');
                
                // Unhide image elements
                //
                //largeImage.style.display = 'block';
                
                // Show the captured photo
                // The inline CSS rules are used to resize the image
                //
                largeImage.src = imageURI;
                
                $("#largeImage").on("load", function(){
                
                    var c = $("#smallCanvas").get(0);
                    var ctx = c.getContext("2d");
                    
                    // TODO
                    c.width = 320;
                    c.height = 239;
                    
                    ctx.drawImage($(this).get(0), 0, 0, 320, 239);
                });                
            }
            
            // A button will call this function
            //
            function capturePhoto() {
                // Take picture using device camera
                // Don't retrieve image as base64-encoded string, it causes memory issues
                navigator.camera.getPicture(onPhotoURISuccess, onFail, {
                    quality: 50, 
                    destinationType: destinationType.FILE_URI, 
                    sourceType: pictureSource.CAMERA });
            }
            
            // A button will call this function
            //
            function capturePhotoEdit() {
                // Take picture using device camera, allow edit
                // Don't retrieve image as base64-encoded string, it causes memory issues
                navigator.camera.getPicture(onPhotoURISuccess, onFail, { 
                quality: 20, 
                allowEdit: true, 
                destinationType: destinationType.FILE_URI, 
                sourceType: pictureSource.CAMERA }); 
            }
            
            // A button will call this function
            //
            function getPhoto(source) {
                // Retrieve image file location from specified source
                navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50, 
                                            destinationType: destinationType.FILE_URI,
                                            sourceType: source });
            }
            
            function detectFace() {
                var $this = $(this);
                
                var coords = $("#smallCanvas").faceDetection({
                    complete:function() {
                        $this.text('Done!');
                    },
                    error:function(img, code, message) {
                        $this.text('error!');
                        alert('Error: '+message);
                    }
                });
                for (var i = 0; i < coords.length; i++) {
                    $('<div>', {
                        'class':'face',
                        'css': {
                            'position':	'absolute',
                            'left':		coords[i].positionX +'px',
                            'top':		coords[i].positionY +'px',
                            'width': 	coords[i].width		+'px',
                            'height': 	coords[i].height	+'px'
                        }
                    })
                    .appendTo('#content');
                }
            }
            
            function debugPhoto(){
                onPhotoURISuccess("img/photo.jpg")
            }
            
            
            // Called if something bad happens.
            // 
            function onFail(message) {
                alert('Failed because: ' + message);
            }
            
            var PREV_TOUCH_POSITION = {};
            
            function showMustache() {
                $('.mustache[id!=mustache]').remove();
            
                $('.face').each(function(i) {
                    var mustache,
                        origMustache,
                        facePosition,
                        mustacheWidth,
                        mustacheHeight,
                        mustacheTop,
                        mustacheLeft,
                        mustacheRatio,
                        faceWidth,
                        faceHeight,
                        faceTop,
                        faceLeft;
                        
                    // create a mustache "instance"
                    origMustache = $('#mustache');
                    mustache = origMustache.clone();
                    
                    facePosition = $(this).position();
                    faceTop = facePosition.top;
                    faceLeft = facePosition.left;
                    faceHeight = $(this).height();
                    faceWidth = $(this).width();
                    
                    // anatomy lesson...
                    mustacheRatio = origMustache.width() / origMustache.height();
                    mustacheHeight = faceHeight / 4;
                    mustacheWidth = mustacheHeight * mustacheRatio;
                    mustacheTop = faceTop + 4/5 * faceHeight - 1/3 * mustacheHeight;
                    mustacheLeft = faceLeft + 1/2 * faceWidth - 1/2 * mustacheWidth;
                    
                    mustache.css({
                        display: 'block',
                        top: mustacheTop,
                        left: mustacheLeft,
                        height: mustacheHeight,
                        width: mustacheWidth
                    });
                    
                    mustache.appendTo('#content');
                    mustache.attr('id', 'mustache' + i);
                    
                    mustache.bind("touchstart click", function(e) {
                        var mustache,
                            mustacheHeight,
                            mustacheWidth,
                            mustacheManipulator,
                            mustacheManipulatorId;
                            
                        e.preventDefault();
                        
                        mustacheManipulatorId = 'manip_' + e.target.id;
                        
                        // don't clone again and again
                        if(document.getElementById(mustacheManipulatorId)) {
                            // TODO $('#' + mustacheManipulatorId).remove();
                            return;
                        }
                        
                        mustacheManipulator = $('#mustacheManipulatorTemplate').clone();
                        mustache = $(this);
                        mustacheHeight = Math.max(50, mustache.height() - 20) + 20;
                        mustacheWidth = Math.max(50, mustache.width() - 20) + 20;    
                        mustacheManipulator.css({
                            top: mustache.position().top + mustache.height() / 2 - mustacheHeight / 2,
                            left: mustache.position().left + mustache.width() / 2 - mustacheWidth / 2,
                            height: mustacheHeight,
                            width: mustacheWidth,
                        });
                        mustacheManipulator.appendTo('#content');
                        mustacheManipulator.attr('id', mustacheManipulatorId);
                                            
                        mustacheManipulator.bind("touchstart touchend", function(e) {
                            PREV_TOUCH_POSITION = {};
                        });
                      
                        mustacheManipulator.bind("mousemove touchmove", function(e) {
                            var mustacheId,
                                move;
                        
                            e.preventDefault();
                        
                            if(e.originalEvent.touches && e.originalEvent.touches.length > 1){
                                return;
                            }
                        
                            if(e.originalEvent.touches && e.originalEvent.touches.length) {
                                e = e.originalEvent.touches[0];
                            } else if(e.originalEvent.changedTouches && e.originalEvent.changedTouches.length) {
                                e = e.originalEvent.changedTouches[0];
                            }
                        
                            move = function(id) {
                                var prevPosition,
                                    currentPosition;
                                    
                                prevPosition = PREV_TOUCH_POSITION[id];
                                currentPosition = $('#' + id).position();
                                if(prevPosition) {
                                    
                                    //var translation = 'translate(' + ( e.pageX-currentPosition.left)+ 'px, ' +(e.pageY-currentPosition.top)+ 'px)';
                                    // Handle mouse move
                                    $('#' + id).css({
                                        left: currentPosition.left + (e.pageX - prevPosition.x), 
                                        top: currentPosition.top + (e.pageY - prevPosition.y)
                                      //'-webkit-transform': translation,
                                      //'-moz-transform': translation,
                                      //'transform': translation
                                    });
                                }
                                
                                // save for later
                                PREV_TOUCH_POSITION[id] = {
                                    x: e.pageX, 
                                    y: e.pageY
                                }; 
                            };
                            
                            mustacheId = e.target.id.replace('manip_', '');
                            move(mustacheId);
                            move(e.target.id);
                        });
    
                           
                        mustacheManipulator.bind('gesturechange', function(e) {
                            var scale,
                                theta,
                                lambda,
                                mustacheId;
                            
                            e.preventDefault();
                            
                            lambda = e.originalEvent.scale;
                            theta = e.originalEvent.rotation;
                            
                            scale = function(id) {
                              $('#' + id).css({
                                  '-moz-transform': 'scale(' + lambda + ') ' + 'rotate(' + theta + 'deg)',
                                  '-webkit-transform': 'scale(' + lambda + ') ' + 'rotate(' + theta + 'deg)',
                                  'transform': 'scale(' + lambda + ') ' + 'rotate(' + theta + 'deg)'
                              });
                            };
                            
                            mustacheId = e.target.id.replace('manip_', '');
                            scale(mustacheId);
                            scale(e.target.id);
                            
                            consoleLog("Scale: " + e.originalEvent.scale + ", Rotation: " + e.originalEvent.rotation);
                        });
                                            
                        
                        
                    });
                });
            }
            
            // TODO
            function saveImageWithMustache() {
                var canvas = $("#largeCanvas"),
                    c = canvas.get(0),
                    ctx = c.getContext("2d");
                                
                ctx.drawImage($('#largeImage').get(0), 0, 0);
                ctx.drawImage($('#mustache1').get(0), 0, 0);
                
                canvas.show();
            }
                       
            function consoleLog(str) {
                $('#console').text(str);
            }
            
            </script>
            <style>
                .face {
                    border:2px solid #FFF;
                }
                #mustache {
             /*       position: absolute;
                    visibility: hidden;
                    display: block;
                    z-index: -1; */
                    display:none
                }
                .mustache,
                .mustacheManipulator {
                    position: absolute;
                    z-index: 2;
                }
                #smallCanvas {
                    z-index: 1;
                }
                #largeImage,
                #largeCanvas,
                #mustacheManipulatorTemplate {
                    display: none;
                }
                .mustacheManipulator {
                    border: 1px solid red;
                }
            </style>
    </head>
    <body>
        <div id="console">console</div>
        <button onclick="capturePhoto();">Capture Photo</button> <br>
        <button onclick="capturePhotoEdit();">Capture Editable Photo</button> <br>
        <button onclick="getPhoto(pictureSource.PHOTOLIBRARY);">From Photo Library</button><br>
        <!--button onclick="getPhoto(pictureSource.SAVEDPHOTOALBUM);">From Photo Album</button><br-->
        <br>
        <button onclick="debugPhoto();">localhost picture</button><br>
        <button onclick="detectFace();">detect face</button><br>
        <button onclick="showMustache();">mustache!</button><br>
        <button onclick="saveImageWithMustache();">save</button><br>
        
        <!--img style="display:none;width:60px;height:60px;" id="smallImage" src="" />
        <img style="display:none;" id="largeImage" src="" /-->
        <div id="container">
            <div id="content">
                <canvas id="smallCanvas"> </canvas>
                <canvas id="largeCanvas"> </canvas>
                <img id="mustache" class="mustache" src="img/mustache.png"/>
                <img id="largeImage"/>
            </div>
        </div>
        
        <div id="mustacheManipulatorTemplate" class="mustacheManipulator"></div>
    </body>
</html>