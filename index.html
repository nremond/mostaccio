<!DOCTYPE html>
<html>
    <head>
        <title>Mostaccio</title>
        
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
        
        <script type="text/javascript" charset="utf-8" src="js/cordova-1.5.0.js"></script>
        <script type="text/javascript" src="js/jquery-1.7.2.js"></script> 
        <script type="text/javascript" src="js/facedetection/ccv.js"></script> 
        <script type="text/javascript" src="js/facedetection/face.js"></script>
        <script type="text/javascript" src="js/jquery.facedetection.js"></script> 
        
        <script type="text/javascript" charset="utf-8">        
            var TRANSFORMATIONS = {},
                preventTranslate = false; // flag to prevent translations after a scale/rotate (2 finger gestures) when release one of the two fingers
            
            $(document).ready(function() {     
                // avoid scrolling the whole page/document
                document.addEventListener('touchmove', function(e) {
                    e.preventDefault();  
                }, false);
                
                // launch face detection when a new image is loaded
                $("#largeImage").on("load", function() {
                    var canvas,
                        ctx;
                
                    canvas = $("#smallCanvas").get(0);
                    ctx = canvas.getContext("2d");
                    
                    // TODO
                    canvas.width = 320;
                    canvas.height = 240;
                    
                   /*if($(this).width() > $(this).height()){
                       // translate context to center of canvas
                       ctx.translate(canvas.width / 2, canvas.height / 2);
                       // rotate 90 degrees clockwise
                       ctx.rotate(Math.PI / 2);  
                       
                       ctx.translate(-canvas.width / 2, -canvas.height / 2);            
                       
                       ctx.drawImage($(this).get(0), 0, 0,  canvas.height, canvas.width);          
                   } else {*/
                       ctx.drawImage($(this).get(0), 0, 0, canvas.width, canvas.height);
                       
                   /*}*/
            
                    detectFace();
                });
            });

            function reset() {
                var canvas,
                    ctx;

                // remove image
                canvas = $("#smallCanvas").get(0);
                ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // remove faces
                $('.face').remove();

                // remove mustaches
                $('.mustache[id!=mustacheTemplate]').remove();
                
                // reset transformations
                TRANSFORMATIONS = {};
            }
            
            function onPhotoURISuccess(imageURI) {
                var largeImage;
                
                reset();
                
                // Get image handle
                largeImage = document.getElementById('largeImage');
                
                // Show the captured photo
                // The inline CSS rules are used to resize the image
                largeImage.src = imageURI;          
            }
            
            // Take picture using device camera
            function capturePhoto() {
                // Don't retrieve image as base64-encoded string, it causes memory issues
                navigator.camera.getPicture(onPhotoURISuccess, consoleLog, {
                    quality: 50, 
                    destinationType: navigator.camera.DestinationType.FILE_URI, 
                    sourceType: navigator.camera.PictureSourceType.CAMERA });
            }
            
            // load a picture from the photo library
            function getPhotoFromLibrary() {
                navigator.camera.getPicture(onPhotoURISuccess, consoleLog, { quality: 50, 
                                            destinationType: navigator.camera.DestinationType.FILE_URI,
                                            sourceType: navigator.camera.PictureSourceType.PHOTOLIBRARY });
            }
            
            function detectFace() {
                $("#smallCanvas").faceDetection({
                    complete:function(img, coords) {
                        for (var i = 0; i < coords.length; i++) {
                            $('<div>', {
                                'class':'face',
                                'css': {
                                    'position':	'absolute',
                                    'left':		coords[i].positionX +'px',
                                    'top':		coords[i].positionY +'px',
                                    'width': 	coords[i].width		+'px',
                                    'height': 	coords[i].height	+'px'
                                }
                            })
                            .appendTo('#picture');
                        }
                    },
                    error:function(img, code, message) {
                        alert('Error: '+message);
                    }
                });
            }
            
            function debugPhoto(){
                onPhotoURISuccess("img/photo.jpg")
            }
                        
            function showMustache(mustacheNumber) {
                var mustaches;
                
                mustaches = $('.mustache[id!=mustacheTemplate]');
                if(mustaches.length > 0){
                    mustaches.each(function(){
                       $(this).attr('src', 'img/mustache-' + mustacheNumber + '.png'); 
                    });
                } else {
                    loadMustache(mustacheNumber);
                } 
            }
                        
            function loadMustache(mustacheNumber) {
                $('.face').each(function(i) {
                    var mustache,
                        origMustache,
                        face;
                        
                    // create a mustache "instance"
                    origMustache = $('#mustacheTemplate');
                    
                    mustache = origMustache.clone();
                    mustache.attr('src', 'img/mustache-' + mustacheNumber + '.png');

                    face = $(this);
                    mustache.on('load', function() {
                        onMustacheImgLoad(mustache, face, i);
                    });                                       
                });
            }
            
            function onMustacheImgLoad(mustache, face, i) {
                var facePosition,
                    faceTop,
                    faceLeft,
                    faceHeight,
                    faceWidth,
                    mustacheWidth,
                    mustacheHeight,
                    mustacheTop,
                    mustacheLeft,
                    mustacheRatio;
                                        
                mustache.off('load');
                           
                facePosition = face.position();
                faceTop = facePosition.top;
                faceLeft = facePosition.left;
                faceHeight = face.height();
                faceWidth = face.width();
                
                // anatomy lesson...
                mustacheRatio = 1; // all our mustaches are square... //mustache.width() / mustache.height();
                mustacheHeight = faceHeight / 1.2; // empirical value based on mustache-*.png image files
                mustacheWidth = mustacheHeight * mustacheRatio;
                mustacheTop = faceTop + 4/5 * faceHeight - 1/3 * mustacheHeight;
                mustacheLeft = faceLeft + 1/2 * faceWidth - 1/2 * mustacheWidth;
                
                mustache.css({
                    display: 'block',
                    top: mustacheTop,
                    left: mustacheLeft,
                    height: mustacheHeight,
                    width: mustacheWidth
                });

                mustache.on('mousemove touchmove', onTouchMove);
                mustache.on('gesturechange', onGestureChange);
                mustache.on('gestureend', onGestureEnd);
                mustache.on('touchend', onTouchEnd);  
                
                mustache.appendTo('#picture');
                mustache.attr('id', 'mustache' + i);       
            }
            
            function onTouchEnd(e) {
                e.preventDefault();
                preventTranslate = false;
            }
            
            function onGestureEnd(e) {
                var mustacheId,
                    trans;
                
                e.preventDefault();
                preventTranslate = true;
                
                mustacheId = e.target.id;
                trans = TRANSFORMATIONS[mustacheId];
                
                trans.prevScale = trans.prevScale || 1;                    
                trans.prevScale *= e.originalEvent.scale;
                
                trans.prevRotate = trans.prevRotate || 0;                    
                trans.prevRotate += e.originalEvent.rotation;
            }
            
            function onGestureChange(e) {
                var theta,
                    lambda,
                    mustacheId,
                    trans,
                    scale,
                    rotation;
                
                e.preventDefault();
                preventTranslate = true;
                
                mustacheId = e.target.id;
                trans = TRANSFORMATIONS[mustacheId];
                
                scale = trans && trans.prevScale ? trans.prevScale : 1;     
                rotation = trans && trans.prevRotate ? trans.prevRotate : 0;   
                
                lambda = e.originalEvent.scale * scale;
                theta = e.originalEvent.rotation + rotation;
                
                doCSSTransform(mustacheId, null, Math.max(lambda, 1), theta);
            }
           
            function onTouchMove(e) {
                var mustacheId,
                    el;
            
                e.preventDefault();
            
                if(preventTranslate || (e.originalEvent.touches && e.originalEvent.touches.length > 1)){
                    return;
                }
            
                if(e.originalEvent.touches && e.originalEvent.touches.length) {
                    e = e.originalEvent.touches[0];
                } else if(e.originalEvent.changedTouches && e.originalEvent.changedTouches.length) {
                    e = e.originalEvent.changedTouches[0];
                }
                
                mustacheId = e.target.id;
                
                el = window.getComputedStyle(document.getElementById(mustacheId), null);
                
                doCSSTransform(mustacheId, {
                    x: Math.floor(e.pageX - pxToNumber(el.left) - pxToNumber(el.width)/2),
                    y: Math.floor(e.pageY - pxToNumber(el.top) - pxToNumber(el.height)/2)
                });
            }
            
            function pxToNumber(pxValue) {
                return Number(pxValue.replace('px','')); 
            }
            
            function doCSSTransform(id, translate, scale, rotate) {
                var transform,
                    t,
                    t_translate,
                    t_rotate,
                    t_scale;
                
                if(!TRANSFORMATIONS[id]) {
                    TRANSFORMATIONS[id] = {};
                }
                t = TRANSFORMATIONS[id];
                
                if(translate) {
                    t.translate = translate;
                }
                if(scale) {
                    t.scale = scale;
                }
                if(rotate) {
                    t.rotate = rotate;
                }
                
                // TODO: 3d transform to use hardware acceleration?
                t_translate =  t.translate ? 'translate(' + t.translate.x + 'px, ' + t.translate.y + 'px) ' : ' '; 
                t_scale = t.scale ? 'scale(' + t.scale + ') ' : ' ';
                t_rotate = t.rotate ? 'rotate(' + t.rotate + 'deg) ' : ' ';
                transform = t_translate + t_rotate + t_scale;

                $('#' + id).css({
                    '-webkit-transform': transform,
                    '-moz-transform': transform,
                    'transform': transform
                });
            }
            
            // TODO
            function saveImageWithMustache() {
                var canvas = $("#largeCanvas"),
                    c = canvas.get(0),
                    ctx = c.getContext("2d");
                                
                ctx.drawImage($('#largeImage').get(0), 0, 0);
                ctx.drawImage($('#mustache1').get(0), 0, 0);
                
                canvas.show();
            }
                       
            function consoleLog(str) {
                if(console && typeof(console.log) === 'function') {
                    console.log(str);
                } else {
                    $('#console').text(str);
                }
            }
            
            </script>
            <style>
                #mustacheTemplate {
             /*       position: absolute;
                    visibility: hidden;
                    display: block;
                    z-index: -1; */
                    display:none
                }
                .mustache {
                    position: absolute;
                    z-index: 3;
                }
                #smallCanvas {
                    image-rendering: -webkit-optimize-contrast;                                     
                    image-rendering: optimize-contrast;   
                    z-index: 1;
                }
                #largeImage,
                #largeCanvas {
                    display: none;
                }
                                            
                /* CSS reset */
                
                /* http://meyerweb.com/eric/tools/css/reset/ 
                   v2.0 | 20110126
                   License: none (public domain)
                */
                
                html, body, div, span, applet, object, iframe,
                h1, h2, h3, h4, h5, h6, p, blockquote, pre,
                a, abbr, acronym, address, big, cite, code,
                del, dfn, em, img, ins, kbd, q, s, samp,
                small, strike, strong, sub, sup, tt, var,
                b, u, i, center,
                dl, dt, dd, ol, ul, li,
                fieldset, form, label, legend,
                table, caption, tbody, tfoot, thead, tr, th, td,
                article, aside, canvas, details, embed, 
                figure, figcaption, footer, header, hgroup, 
                menu, nav, output, ruby, section, summary,
                time, mark, audio, video {
                    margin: 0;
                    padding: 0;
                    border: 0;
                    font-size: 100%;
                    font: inherit;
                    vertical-align: baseline;
                }
                /* HTML5 display-role reset for older browsers */
                article, aside, details, figcaption, figure, 
                footer, header, hgroup, menu, nav, section {
                    display: block;
                }
                body {
                    line-height: 1;
                }
                ol, ul {
                    list-style: none;
                }
                blockquote, q {
                    quotes: none;
                }
                blockquote:before, blockquote:after,
                q:before, q:after {
                    content: '';
                    content: none;
                }
                table {
                    border-collapse: collapse;
                    border-spacing: 0;
                }
                
                /* layout */
                
                #application {
                    height: 460px;
                    width: 320px;
                    position: absolute;
                    background: black;
                }
                #picture {
                    height: 416px;
                    width: 320px;
                    position: absolute;
                }
                #mustachebar {
                    width: 320px;
                    position: absolute;
                    bottom: 44px; /* toolbar height */
                    text-align: center; /* center mustaches */
                    z-index: 4; /* above everything else */
                }
                #mustachebar img {
                    background: white;
                }
                #toolbar {
                    background: green;
                    height: 44px;
                    position: absolute;
                    width: 320px;
                    bottom: 0;
                    text-align: center; /* center buttons */
                    z-index: 4; /* above everything else */
                }
                #toolbar button {
                    width: 31%;
                    border: 0;
                    background: none;
                    color: white;
                    height: 100%;
                }
                
                /* to remove/hide... */
                
                #devStuff {
                    position: absolute;
                    z-index: 3;
                }
                #console {
                    background: black;
                    color: white;
                }
                .face {
                    border: 1px dotted #FFF;
                    z-index: 2;
                }
                .mustache {
                    border: 1px dotted red;
                }
            </style>
    </head>
    <body>
        <!-- dev stuff -->
        <div id="devStuff">
            <div id="console">console</div>
            <button onclick="debugPhoto();">localhost picture</button>
        </div>

        <!-- template, will be cloned -->        
        <img id="mustacheTemplate" class="mustache" src=""/>
        
        <!-- never displayed, used only for importing picture and saving -->
        <img id="largeImage"/>
        <canvas id="largeCanvas"> </canvas>
        
        <!-- app layout -->
        <div id="application">
            <div id="picture">
                <canvas id="smallCanvas"></canvas>
            </div>
            <div id="mustachebar">
                <img src="img/mustache-small-1.png" onclick="showMustache(1);"/>
                <img src="img/mustache-small-2.png" onclick="showMustache(2);"/>
                <img src="img/mustache-small-3.png" onclick="showMustache(3);"/>
                <img src="img/mustache-small-4.png" onclick="showMustache(4);"/>
                <img src="img/mustache-small-5.png" onclick="showMustache(5);"/>
            </div>
            <div id="toolbar">
                <button onclick="getPhotoFromLibrary();">Library</button>
                <button onclick="capturePhoto();">Capture</button>
                <button onclick="saveImageWithMustache();">Save</button>
            </div>
        </div>
    </body>
</html>